{% extends "base.html" %}

{% block title %}SB Gear - Оформлення замовлення{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        {% if success %}

        <div class="card border-success mb-4">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0"><i class="bi bi-check-circle-fill me-2"></i>Замовлення успішно прийнято!</h4>
            </div>
            <div class="card-body">
                <div class="text-center py-4">
                    <i class="bi bi-check-circle text-success display-1 mb-3"></i>
                    <h3 class="mb-3">Дякуємо за ваше замовлення!</h3>
                    <p class="lead mb-4">Ми зв'яжемося з вами протягом 30 хвилин для підтвердження.</p>
                    
                    <div class="alert alert-info mb-4">
                        <h5><i class="bi bi-info-circle me-2"></i>Деталі замовлення:</h5>
                        <div class="row mt-3">
                            <div class="col-md-6 mb-2">
                                <strong>Номер замовлення:</strong><br>
                                <span class="text-primary">#{{ "%06d"|format(order_id) if order_id else "000001" }}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <strong>Сума:</strong><br>
                                <span class="text-primary">{{ total_price if total_price else "0" }} ₴</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
                            <i class="bi bi-house me-2"></i>На головну
                        </a>
                        <a href="{{ url_for('catalog_page') }}" class="btn btn-outline-primary btn-lg">
                            <i class="bi bi-bag me-2"></i>Продовжити покупки
                        </a>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Що далі?</h5>
                        <div class="row text-center mt-3">
                            <div class="col-md-4">
                                <div class="p-3">
                                    <i class="bi bi-telephone text-primary fs-1 mb-2"></i>
                                    <p class="mb-0 small">Очікуйте дзвінка менеджера</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3">
                                    <i class="bi bi-truck text-primary fs-1 mb-2"></i>
                                    <p class="mb-0 small">Доставка 1-3 робочих дні</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3">
                                    <i class="bi bi-credit-card text-primary fs-1 mb-2"></i>
                                    <p class="mb-0 small">Оплата при отриманні</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-person-circle me-2"></i>Контактні дані</h4>
            </div>
            <div class="card-body">
                <form method="POST" class="row g-3 needs-validation" novalidate>
                    <div class="col-md-6">
                        <label for="name" class="form-label">
                            <i class="bi bi-person me-1"></i>Ім'я та прізвище <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="name" name="name" required 
                               placeholder="Введіть ваше ім'я">
                        <div class="invalid-feedback">
                            Будь ласка, введіть ваше ім'я.
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="phone" class="form-label">
                            <i class="bi bi-phone me-1"></i>Телефон <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <span class="input-group-text">+380</span>
                            <input type="tel" class="form-control" id="phone" name="phone" required
                                   placeholder="XX XXX XX XX" pattern="[0-9]{9}" 
                                   title="Введіть 9 цифр номера телефону">
                        </div>
                        <div class="invalid-feedback">
                            Введіть коректний номер телефону (9 цифр).
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="email" class="form-label">
                            <i class="bi bi-envelope me-1"></i>Email
                        </label>
                        <input type="email" class="form-control" id="email" name="email" 
                               placeholder="email@example.com">
                        <div class="form-text">Для надсилання деталей замовлення</div>
                    </div>
                    
                    <div class="col-md-6">
                        <label for="city" class="form-label">
                            <i class="bi bi-geo-alt me-1"></i>Місто <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="city" name="city" required 
                               placeholder="Введіть місто">
                        <div class="invalid-feedback">
                            Будь ласка, введіть місто доставки.
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label for="address" class="form-label">
                            <i class="bi bi-house me-1"></i>Адреса доставки <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="address" name="address" rows="2" required 
                                  placeholder="Вулиця, будинок, квартира"></textarea>
                        <div class="invalid-feedback">
                            Будь ласка, введіть адресу доставки.
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <label for="comment" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>Коментар до замовлення
                        </label>
                        <textarea class="form-control" id="comment" name="comment" rows="3" 
                                  placeholder="Додаткові побажання, час доставки тощо"></textarea>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agree" required>
                            <label class="form-check-label" for="agree">
                                Я погоджуюсь з <a href="#" class="text-decoration-none">правилами обробки персональних даних</a>
                                та <a href="#" class="text-decoration-none">умовами покупки</a> <span class="text-danger">*</span>
                            </label>
                            <div class="invalid-feedback">
                                Ви повинні погодитися перед відправленням.
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="d-grid gap-2 d-md-flex">
                            <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                                <i class="bi bi-check-circle me-2"></i>Підтвердити замовлення
                            </button>
                            <a href="{{ url_for('cart') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-arrow-left me-2"></i>Повернутися
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-lg-4">

        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-cart-check me-2"></i>Ваше замовлення</h5>
            </div>
            <div class="card-body">
                {% if session.get('cart') %}
                    {% set cart_total = namespace(value=0) %}
                    <div class="order-items mb-3">
                        {% for product_id, qty in session['cart'].items() %}
                            {% set product = items|selectattr('id', 'equalto', product_id|int)|first if items else none %}
                            {% if product %}
                                <div class="d-flex mb-3 pb-3 border-bottom">
                                    <img src="{{ url_for('static', filename='img/' + (product['image'] or 'placeholder.png')) }}" 
                                         class="rounded" style="width: 60px; height: 60px; object-fit: cover;" 
                                         alt="{{ product['name'] }}">
                                    <div class="ms-3 flex-grow-1">
                                        <h6 class="mb-1">{{ product['name'] }}</h6>
                                        <div class="d-flex justify-content-between">
                                            <div class="text-muted small">
                                                {{ qty }} × {{ product['price'] }} ₴
                                            </div>
                                            <div class="fw-bold">
                                                {{ product['price'] * qty }} ₴
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% set cart_total.value = cart_total.value + (product['price'] * qty) %}
                            {% endif %}
                        {% endfor %}
                    </div>
                    
                    <div class="order-summary">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Товари:</span>
                            <span>{{ cart_total.value }} ₴</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Доставка:</span>
                            <span class="text-success">Безкоштовно</span>
                        </div>
                        {% if cart_total.value > 2000 %}
                            <div class="alert alert-success py-2 mb-3">
                                <i class="bi bi-truck me-1"></i>
                                <small>Безкоштовна доставка від 2000₴</small>
                            </div>
                        {% endif %}
                        <hr>
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="mb-0">Разом:</h5>
                            <h4 class="text-primary mb-0">{{ cart_total.value }} ₴</h4>
                        </div>
                    </div>
                    
                    <div class="payment-methods mt-4">
                        <h6 class="mb-3"><i class="bi bi-credit-card me-2"></i>Способи оплати:</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="border rounded p-2 text-center">
                                    <i class="bi bi-cash-coin text-success d-block fs-4 mb-1"></i>
                                    <small>Готівкою при отриманні</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="border rounded p-2 text-center">
                                    <i class="bi bi-credit-card text-primary d-block fs-4 mb-1"></i>
                                    <small>Онлайн оплата картою</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="delivery-info mt-4">
                        <h6 class="mb-3"><i class="bi bi-truck me-2"></i>Доставка:</h6>
                        <div class="small text-muted">
                            <p class="mb-1"><i class="bi bi-check-circle text-success me-1"></i>Нова Пошта - 1-3 дні</p>
                            <p class="mb-1"><i class="bi bi-check-circle text-success me-1"></i>Укрпошта - 3-5 днів</p>
                            <p class="mb-1"><i class="bi bi-check-circle text-success me-1"></i>Самовивіз з Києва</p>
                        </div>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-cart-x display-4 text-muted mb-3"></i>
                        <p class="text-muted">Ваш кошик порожній</p>
                        <a href="{{ url_for('catalog_page') }}" class="btn btn-primary">
                            Перейти до покупок
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .sticky-top {
        position: sticky;
        top: 20px;
    }
    
    .order-items {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--sb-accent);
        box-shadow: 0 0 0 0.25rem rgba(255, 102, 0, 0.25);
    }
    
    .btn-primary {
        background-color: var(--sb-accent);
        border-color: var(--sb-accent);
    }
    
    .btn-primary:hover {
        background-color: #e65c00;
        border-color: #e65c00;
    }
</style>

<script>

    (function () {
        'use strict'
        
        const forms = document.querySelectorAll('.needs-validation')
        
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                
                form.classList.add('was-validated')
            }, false)
        })
    })()
    

    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 9) value = value.substring(0, 9);
            
            let formatted = '';
            if (value.length > 0) formatted = value.substring(0, 2);
            if (value.length > 2) formatted += ' ' + value.substring(2, 5);
            if (value.length > 5) formatted += ' ' + value.substring(5, 7);
            if (value.length > 7) formatted += ' ' + value.substring(7, 9);
            
            e.target.value = formatted;
        });
    }
    

    const cityInput = document.getElementById('city');
    if (cityInput) {
        const popularCities = ['Київ', 'Харків', 'Одеса', 'Дніпро', 'Львів', 'Запоріжжя'];
        
        cityInput.addEventListener('input', function(e) {
            const value = e.target.value.toLowerCase();
            if (value.length > 1) {
                const datalist = document.createElement('datalist');
                datalist.id = 'city-suggestions';
                
                popularCities.forEach(city => {
                    if (city.toLowerCase().includes(value)) {
                        const option = document.createElement('option');
                        option.value = city;
                        datalist.appendChild(option);
                    }
                });
                
                const existingDatalist = document.getElementById('city-suggestions');
                if (existingDatalist) {
                    existingDatalist.remove();
                }
                
                if (datalist.children.length > 0) {
                    cityInput.setAttribute('list', 'city-suggestions');
                    document.body.appendChild(datalist);
                }
            }
        });
    }
</script>
{% endblock %}
